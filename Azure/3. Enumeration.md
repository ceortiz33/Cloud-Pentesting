## Unauthenticated Enumeration

### AADInternals
Get login information
```
Get-AADIntLoginInformation -Domain domain.com
```
Get tenant ID
```
Get-AADIntTenantID -Domain domain.com
```

Gets all verified domains of the tenant
```
Invoke-AADIntReconAsOutsider -DomainName domain.com
```

Get Subdomains
```
cd /opt; git clone https://github.com/yuyudhn/AzSubEnum
cd AzSubEnum; pip3 install -r requirements.txt
python3 azsubenum.py -b megabigtech  -t 10 -p permutations.txt
```

## Authenticated Enumeration

Get current user with Powershell
```
Get-AzADUser -SignedIn | fl
Get-AzContext
Get-AzContext -ListAvailable
```
Get current user with Microsoft Graph
```
Get-MgContext
```
Get all users in the tenant
```
Get-AzADUser
```
Get information of specific user
```
Get-AzADUser -UserPrincipalName 'user@domain.com' | fl
```
Get current user with Azure cli
```
az account show
az ad signed-in-user show
```
List users available in Entra ID filter by givenName
```
az ad user list --query "[?givenName=='name1' || givenName=='name2' || givenName=='name3'].{Name:displayName, UPN:userPrincipalName, JobTitle:jobTitle}" -o table
```
Get role
```
Get-AzRoleAssignment
```
Get Groups
```
Get-MgUserMemberOf -userid "user@domain.com" | select * -ExpandProperty additionalProperties | Select-Object {$_.AdditionalProperties["displayName"]}
```
Get Groups user own
```
Get-MgUserOwnedObject -UserId "user@domain.com"
```
Get UserId for the user
```
Get-MgUser -UserId user@domain.com
Get-MgUser -UserId $UID
Get-MgUser -UserId $UID | fl
```
Look for Administrative Units
```
Get-MgDirectoryAdministrativeUnit | fl
```
Get Role member
```
Get-MgDirectoryAdministrativeUnitScopedRoleMember -AdministrativeUnitId 4a3288aa-1a8b-485a-8ced-2bd80feef625
```
Get Directory Role
```
Get-MgDirectoryRole -DirectoryRoleId 44f23f5b-69bb-41a4-a417-c5427772de41 | fl
```
Get Directory Unit Member
```
Get-MgDirectoryAdministrativeUnitMember -AdministrativeUnitId 4a3288aa-1a8b-485a-8ced-2bd80feef625
```
Look for Dynamic Groups
```
$dynamicGroups = Get-MgGroup -Filter "groupTypes/any(c:c eq 'DynamicMembership')"

foreach ($group in $dynamicGroups) {
    $groupName = $group.DisplayName
    $membershipQuery = $group.MembershipRule
    Write-Output "Group Name: $groupName, Membership Query: $membershipQuery"
}
```
Get-Dynamic groups with Graphrunner
```
Get-DynamicGroups -Tokens $tokens
```
Get Azure AD Users
```
Get-AzureADUsers -Tokens $tokens â€“outfile users.txt
```
Get subscription
```
Get-AzSubscription
```
Get resource of current user
```
Get-AzResource
```
Get license
```
Get-MgUserLicenseDetail -UserId "userr@domain.com"
```
List resources in the current subscription
```
# Given subscription ID
$CurrentSubscriptionID = "<SUBSCRIPTION-ID>"

# Set output format
$OutputFormat = "table"

# Set the given subscription as the active one
& az account set --subscription $CurrentSubscriptionID

# List resources in the current subscription
& az resource list -o $OutputFormat
```
List permissions assigned
```
Get-AzRoleAssignment -Scope "/subscriptions/<SUBSCRIPTION-ID>" | Select-Object DisplayName, RoleDefinitionName
Get-AzRoleAssignment -SignInName user@domain.com
```
Inspect specific permissions(RBAC)
```
az role definition list --custom-role-only true --query "[?roleName=='Customer Database Access']" -o json
```
Get Directory roles
```
$userEmail = "user@domain.com"
$user = Get-MgUser -Filter "userPrincipalName eq '$userEmail'"

$directoryRoles = Get-MgDirectoryRole

$userRoleNames = @()

foreach ($role in $directoryRoles) {
    $members = Get-MgDirectoryRoleMember -DirectoryRoleId $role.Id
    if ($members.Id -contains $user.Id) {
        $userRoleNames += $role.DisplayName
    }
}

$userRoleNames
```
Get Users with the same Directory role
```
foreach ($member in $ScopedRoleMembers) {
    $userId = $member.RoleMemberInfo.Id
    
    if (-not $userId) {
        Write-Output "No user ID available for member with Role ID: $($member.RoleId)"
        continue
    }

    $userDetails = Get-MgUser -UserId $userId
    
    if ($userDetails) {
        Write-Output "User Details: Name - $($userDetails.DisplayName), Email - $($userDetails.Mail), Role ID - $($member.RoleId)"
    } else {
        Write-Output "Failed to retrieve details for user ID: $userId"
    }
}
```

### VM Enumeration

List virtual machines
```
az vm list --output table
```
Get Public and Private IPs
```
az vm list-ip-addresses --output table
```
Command execution on virtual machines
```
#vm-cmd.ps1
whoami

az vm run-command invoke \
--resource-group "mbt-rg-16" \
--name "NAME" \
--command-id 'RunPowerShellScript' \
--scripts @vm-cmd.ps1
```

### Storage Accounts

List storage accounts
```
az storage account list --query "[].name" -o tsv
```
List tables
```
az storage table list --account-name custdatabase --output table --auth-mode login
```
Get table content
```
az storage entity query --table-name customers --account-name custdatabase --output table --auth-mode login
```
Identify blob container using basicblobfinder
```
cd /opt; git clone https://github.com/joswr1ght/basicblobfinder
cd basicblobfinder; rm namelist
for word in $(cat ../AzSubEnum/permutations.txt); do echo megabigtechinternal:$word
>> namelist; done
python3 basicblobfinder.py namelist
```
List storage blob
```
az storage blob list --account-name mbtresearch --container-name
research-files --auth-mode login
```
Download files from blob storage
```
az storage blob download --account-name mbtresearch --container-name research-files --auth-mode login
```
Download specific file from blob storage
```
az storage blob download --account-name mbtresearch --container-name research-files --auth-mode login --name FILE --file FILE
```

### Web Apps 

Inspect source code looking for Storage resource
```
Blob Storage	        https://<storage-account-name>.blob.core.windows.net
Data Lake Storage Gen2	https://<storage-account-name>.dfs.core.windows.net
Azure Files	        https://<storage-account-name>.file.core.windows.net
Queue Storage	        https://<storage-account-name>.queue.core.windows.net
Table Storage	        https://<storage-account-name>.table.core.windows.net

Reference List of domains used by Azure
https://learn.microsoft.com/en-us/azure/security/fundamentals/azure-domains
```
Inspect headers with Powershell
```
Invoke-WebRequest -Uri 'https://mbtwebsite.blob.core.windows.net/$web/index.html'
```
Inspect headers with curl
```
curl -I '<site>'
```
Exploring $web container
Looking for all blobs inside the $web container
```
https://mbtwebsite.blob.core.windows.net/$web?restype=container&comp=list
```
Looking for all directories inside the $web container
```
https://mbtwebsite.blob.core.windows.net/$web?restype=container&comp=list&delimiter=%2F
```
Looking for previous versioning in blob storage(2019-12-12 and later)
```
curl -H "x-ms-version: 2019-12-12" 'https://mbtwebsite.blob.core.windows.net/$web?restype=container&comp=list&include=versions'
```
Beautify xml output of blob versioning
```
apt install libxml2-utils
curl -H "x-ms-version: 2019-12-12" 'https://mbtwebsite.blob.core.windows.net/$web?restype=container&comp=list&include=versions' | xmllint --format - | less
```
Download resources from $web container using curl
```
curl -H "x-ms-version: 2019-12-12" 'https://mbtwebsite.blob.core.windows.net/$web/scripts-transfer.zip?versionId=2024-03-29T20:55:40.8265593Z'  --output scripts-transfer.zip
```
Gather information of the Webapp Accounts
```
Get-AzWebApp -Name domain
Get-AzWebApp -Name domain | select enabledhostnames
```
Roles that can access Kudu
```
https://learn.microsoft.com/en-us/azure/app-service/resources-kudu#rbac-permissions-required-to-access-kudu
```
List environmental variables
```
env | grep -i -e "DB"
```

## Certificates

Get certificate information
```
Get-PfxCertificate -FilePath "C:\Users\User\Downloads\file.pfx" | fl
```
Import Certificate in Windows
```
Get-ChildItem -Path C:\Users\user\Downloads\file.pfx | Import-PfxCertificate -CertStoreLocation Cert:\CurrentUser\My -Exportable
```
Convert pfx certificate to pem(Linux)
```
openssl pkcs12 -in file.pfx -out file.pem -nodes -clcerts
```
